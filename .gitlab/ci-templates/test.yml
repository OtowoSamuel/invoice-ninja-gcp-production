# Test Template - Reusable Testing Jobs
# Learn: Unit tests, integration tests, code quality

.test_template:
  stage: test
  image: php:8.2-cli-alpine
  before_script:
    # Install dependencies
    - apk add --no-cache git postgresql-dev libzip-dev libpng-dev libjpeg-turbo-dev freetype-dev
    - docker-php-ext-install pdo_pgsql bcmath zip gd
    # Initialize submodules
    - rm -rf invoiceninja
    - git submodule update --init --recursive --depth 20
    # Install Composer
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    # Install project dependencies
    - cd invoiceninja
    - composer install --no-interaction --no-progress --prefer-dist
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - invoiceninja/vendor/
  retry:
    max: 2

# Unit Tests
test:unit:
  extends: .test_template
  script:
    - php artisan test --parallel
  artifacts:
    when: always
    reports:
      junit: invoiceninja/junit.xml
    expire_in: 1 week

# Code Quality Analysis
test:code-quality:
  stage: test
  image: php:8.2-cli-alpine
  before_script:
    - apk add --no-cache git
    - rm -rf invoiceninja
    - git submodule update --init --recursive --depth 20
    - cd invoiceninja
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    - composer global require phpstan/phpstan
    - export PATH="$PATH:$HOME/.composer/vendor/bin"
  script:
    - phpstan analyse --level=5 --error-format=gitlab > phpstan-report.json || true
  artifacts:
    reports:
      codequality: invoiceninja/phpstan-report.json
    expire_in: 1 week
  allow_failure: true

# PHP Code Sniffer
test:code-style:
  stage: test
  image: php:8.2-cli-alpine
  before_script:
    - apk add --no-cache git
    - rm -rf invoiceninja
    - git submodule update --init --recursive --depth 20
    - cd invoiceninja
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    - composer global require squizlabs/php_codesniffer
    - export PATH="$PATH:$HOME/.composer/vendor/bin"
  script:
    - phpcs --standard=PSR12 --report=gitlab app/ > phpcs-report.json || true
  artifacts:
    reports:
      codequality: invoiceninja/phpcs-report.json
    expire_in: 1 week
  allow_failure: true

# Integration Tests (with Database)
test:integration:
  extends: .test_template
  services:
    - postgres:15-alpine
  variables:
    POSTGRES_DB: testing
    POSTGRES_USER: invoiceninja
    POSTGRES_PASSWORD: testing
    DB_CONNECTION: pgsql
    DB_HOST: postgres
    DB_PORT: 5432
    DB_DATABASE: testing
    DB_USERNAME: invoiceninja
    DB_PASSWORD: testing
    APP_ENV: testing
    APP_DEBUG: "true"
  script:
    # Create minimal .env file for Laravel
    - |
      cat > .env << EOF
      APP_NAME="Invoice Ninja"
      APP_ENV=testing
      APP_DEBUG=true
      APP_URL=http://localhost
      APP_KEY=
      DB_CONNECTION=pgsql
      DB_HOST=postgres
      DB_PORT=5432
      DB_DATABASE=testing
      DB_USERNAME=invoiceninja
      DB_PASSWORD=testing
      CACHE_DRIVER=array
      SESSION_DRIVER=array
      QUEUE_CONNECTION=sync
      EOF
    - php artisan key:generate --force
    - php artisan migrate --force
    - php artisan test --testsuite=Integration
  artifacts:
    when: always
    reports:
      junit: invoiceninja/junit.xml
    expire_in: 1 week

# E2E Tests (Placeholder for Cypress/Playwright)
test:e2e:
  stage: test
  image: mcr.microsoft.com/playwright:v1.40.0-focal
  services:
    - postgres:15-alpine
  variables:
    POSTGRES_DB: testing
    POSTGRES_USER: invoiceninja
    POSTGRES_PASSWORD: testing
  before_script:
    - apt-get update && apt-get install -y git
    - rm -rf invoiceninja
    - git submodule update --init --recursive --depth 20
    - cd invoiceninja
    - test -f package.json && npm install || echo "No package.json found, skipping npm install"
  script:
    - test -f package.json && npx playwright test || echo "No E2E tests configured"
  artifacts:
    when: always
    paths:
      - playwright-report/
      - test-results/
    expire_in: 1 week
  allow_failure: true
  only:
    - merge_requests
    - main
