# Supervisor Configuration for Queue Worker
# WHY: Manages queue worker process with auto-restart and graceful shutdown

[supervisord]
nodaemon=true
user=root
logfile=/dev/stdout
logfile_maxbytes=0
pidfile=/tmp/supervisord.pid

# Laravel Queue Worker
[program:queue-worker]
command=php artisan queue:work --sleep=3 --tries=3 --max-time=3600
directory=/var/www/html
user=invoiceninja
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

# CRITICAL: Graceful shutdown settings
# stopwaitsecs: How long to wait for graceful shutdown before SIGKILL
# LEARNING: Set this higher than your longest expected job duration!
stopwaitsecs=60
stopsignal=TERM  # Send SIGTERM for graceful shutdown

# LEARNING: What happens on shutdown?
# 1. Supervisor sends SIGTERM to worker
# 2. Worker finishes current job (up to stopwaitsecs)
# 3. Worker exits cleanly
# 4. If timeout, supervisor sends SIGKILL (force kill, job may be lost)

# Process priority
priority=10
